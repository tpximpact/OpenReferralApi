using System.Net;
using System.Reflection;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.RateLimiting;
using HealthChecks.UI.Client;
using Microsoft.AspNetCore.Diagnostics.HealthChecks;
using Microsoft.AspNetCore.RateLimiting;
using Microsoft.Extensions.Diagnostics.HealthChecks;
using OpenReferralApi.Core.Services;
using OpenReferralApi.Middleware;
using OpenReferralApi.Telemetry;
using OpenTelemetry.Metrics;
using OpenTelemetry.Resources;
using OpenTelemetry.Trace;

var builder = WebApplication.CreateBuilder(args);

builder.Configuration.AddEnvironmentVariables("ORUK_API_");

// Add services to the container.
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =>
{
    var xmlFilename = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";
    options.IncludeXmlComments(Path.Combine(AppContext.BaseDirectory, xmlFilename));
    
    options.SwaggerDoc("v1", new() 
    { 
        Title = "Open Referral UK API", 
        Version = "v1",
        Description = "API for validating and monitoring Open Referral UK data feeds",
        Contact = new() 
        { 
            Name = "Open Referral UK", 
            Url = new Uri("https://openreferraluk.org") 
        }
    });
});

// CORS - Environment-specific origins
var allowedOrigins = builder.Configuration.GetSection("Security:AllowedCorsOrigins").Get<string[]>() 
                     ?? new[] { "*" };

builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        if (allowedOrigins.Contains("*"))
        {
            policy.AllowAnyOrigin()
                  .AllowAnyMethod()
                  .AllowAnyHeader();
        }
        else
        {
            policy.WithOrigins(allowedOrigins)
                  .AllowAnyMethod()
                  .AllowAnyHeader()
                  .AllowCredentials();
        }
    });
});

// Rate Limiting
builder.Services.AddRateLimiter(options =>
{
    options.RejectionStatusCode = StatusCodes.Status429TooManyRequests;
    
    options.AddFixedWindowLimiter("fixed", opt =>
    {
        opt.PermitLimit = builder.Configuration.GetValue<int>("RateLimiting:PermitLimit", 100);
        opt.Window = TimeSpan.FromSeconds(builder.Configuration.GetValue<int>("RateLimiting:Window", 60));
        opt.QueueProcessingOrder = QueueProcessingOrder.OldestFirst;
        opt.QueueLimit = builder.Configuration.GetValue<int>("RateLimiting:QueueLimit", 0);
    });
});

// Configure HTTP client with environment-based security settings
var validateSslCertificates = builder.Configuration.GetValue<bool>("Security:ValidateSslCertificates", true);

builder.Services.AddHttpClient(nameof(OpenApiValidationService), client =>
{
    // Set a standard user agent that most APIs accept
    client.DefaultRequestHeaders.Add("User-Agent", "OpenReferral-Validator/1.0");

    // Set reasonable timeout
    client.Timeout = TimeSpan.FromMinutes(2);
})
.ConfigurePrimaryHttpMessageHandler(() =>
{
    var handler = new HttpClientHandler();

    // Configure SSL/TLS settings based on environment
    if (!validateSslCertificates)
    {
        var logger = builder.Services.BuildServiceProvider()
            .GetRequiredService<ILogger<Program>>();
        logger.LogWarning("SSL certificate validation is DISABLED. This should only be used in development.");
        
        handler.ServerCertificateCustomValidationCallback = (sender, cert, chain, sslPolicyErrors) => true;
    }

    // Enable automatic decompression for better compatibility
    handler.AutomaticDecompression = DecompressionMethods.GZip | DecompressionMethods.Deflate;

    return handler;
});

builder.Services.AddHttpClient();
builder

// Response Caching
var mongoConnectionString = builder.Configuration.GetValue<string>("Database:ConnectionString");
var healthChecksBuilder = builder.Services.AddHealthChecks()
    .AddCheck("self", () => HealthCheckResult.Healthy(), tags: new[] { "ready" });

if (!string.IsNullOrEmpty(mongoConnectionString))
{
    healthChecksBuilder.AddMongoDb(
        mongoConnectionString,
        name: "mongodb",
        timeout: TimeSpan.FromSeconds(3),
        tags: new[] { "ready", "db" });
}

// Add HTTP endpoint health check for external API validation
healthChecksBuilder.AddUrlGroup(
    new Uri("https://openreferraluk.org"),
    name: "openreferral-website",
    timeout: TimeSpan.FromSeconds(5),
    tags: new[] { "external
{
    options.AddBasePolicy(builder => builder.Cache());
    options.AddPolicy("MockEndpoints", builder => 
        builder.Expire(TimeSpan.FromMinutes(5)));
});.Services.AddControllers()
    .AddJsonOptions(options =>
    {
// Exception Handlers
builder.Services.AddExceptionHandler<GlobalExceptionHandler>();
builder.Services.AddProblemDetails();

        options.JsonSerializerOptions.DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull;
    });

app.UseExceptionHandler();

// Middleware
app.UseMiddleware<CorrelationIdMiddleware>();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "Open Referral UK API v1");
        c.RoutePrefix = string.Empty; // Serve Swagger UI at root
        c.DisplayRequestDuration();
    });
}
else
{
    app.UseHsts(er.Services.AddScoped<IJsonSchemaResolverService, JsonSchemaResolverService>();
builder.Services.AddScoped<IJsonValidatorService, JsonValidatorService>();
builder.Services.AddScoped<IOpenApiValidationService>(provider =>
{
    var logger = provider.GetRequiredService<ILogger<OpenApiValidationService>>();
    var httpClientFactory = provider.GetRequiredService<IHttpClientFactory>();
    var httpClient = httpClientFactory.CreateClient(nameof(OpenApiValidationService));
    var jsonValidatorService = provider.GetRequiredService<IJsonValidatorService>();
    var schemaResolverService = provider.GetRequiredService<IJsonSchemaResolverService>();
    return new OpenApiValidationService(logger, httpClient, jsonValidatorService, schemaResolverService);
});

// Register OpenAPI discovery service used by controller to discover openapi_url from BaseUrl
builder.Services.AddScoped<IOpenApiDiscoveryService, OpenApiDiscoveryService>();

// Register OpenAPI to ValidationResponse mapper
builder.Services.AddScoped<IOpenApiToValidationResponseMapper, OpenApiToValidationResponseMapper>();

builder.Services.AddMemoryCache();

var app = builder.Build();

// Configure the HTTP request pipeline
app.UseResponseCaching();
app.UseOutputCache();
app.UseRateLimiter();
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "JSON Validator API v1");
        c.RoutePrefix = string.Empty; // Serve Swagger UI at root
    });
}

// Health check endpoints with detailed responses
app.MapHealthChecks("/health-check", new HealthCheckOptions
{
    Predicate = _ => true,
    ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse
});

app.MapHealthChecks("/health-check/ready", new HealthCheckOptions
{
    Predicate = check => check.Tags.Contains("ready"),
    ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse
});

app.MapHealthChecks("/health-check/live", new HealthCheckOptions
{
    Predicate = _ => false, // Just returns 200 OK if app is running
    ResponseWriter = async (context, _) =>
    {
        context.Response.ContentType = "application/json";
        await context.Response.WriteAsync(JsonSerializer.Serialize(new 
        { 
            status = "Healthy",
            timestamp = DateTime.UtcNow
        }));
    }
});

app.UseRouting();
app.UseCors();
app.UseHttpsRedirection();

app.MapControllerRoute(name: "default", pattern: "{controller}/{action=Index}/{id?}");

app.Run();
